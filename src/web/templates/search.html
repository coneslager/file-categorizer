{% extends "base.html" %}

{% block title %}Search Files - File Categorizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-filter me-2"></i>Search Files
        </h1>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Criteria</h5>
            </div>
            <div class="card-body">
                <form id="search-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="search-query" class="form-label">Search Query</label>
                            <input type="text" class="form-control" id="search-query"
                                placeholder="Enter filename or path...">
                        </div>
                        <div class="col-md-3">
                            <label for="category-filter" class="form-label">Category</label>
                            <select class="form-select" id="category-filter">
                                <option value="">All Categories</option>
                                <option value="graphics">Graphics</option>
                                <option value="lightburn">LightBurn</option>
                                <option value="vector">Vector</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="results-limit" class="form-label">Results Limit</label>
                            <select class="form-select" id="results-limit">
                                <option value="50">50 results</option>
                                <option value="100">100 results</option>
                                <option value="250">250 results</option>
                                <option value="500">500 results</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Filters (Collapsible) -->
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                            data-bs-target="#advanced-filters">
                            <i class="bi bi-gear me-1"></i>Advanced Filters
                        </button>
                    </div>

                    <div class="collapse mt-3" id="advanced-filters">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="min-size" class="form-label">Min Size (bytes)</label>
                                <input type="number" class="form-control" id="min-size" min="0">
                            </div>
                            <div class="col-md-6">
                                <label for="max-size" class="form-label">Max Size (bytes)</label>
                                <input type="number" class="form-control" id="max-size" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-2"></i>Search
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="clear-search">
                            <i class="bi bi-x-circle me-2"></i>Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search Results -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Search Results</h5>
                <div class="d-flex align-items-center gap-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Use <i class="bi bi-clipboard"></i> to copy file path, <i class="bi bi-folder"></i> to copy
                        folder path
                    </small>
                    <div id="results-info" class="text-muted small"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="search-results">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-search fs-1"></i>
                        <p class="mb-0">Enter search criteria and click "Search" to find files</p>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="loading-indicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Searching files...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSearchData = [];
    let currentSort = { key: null, direction: 'asc' };

    document.addEventListener('DOMContentLoaded', function () {

        const searchForm = document.getElementById('search-form');
        const clearButton = document.getElementById('clear-search');

        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            performSearch();
        });

        clearButton.addEventListener('click', function () {
            clearSearch();
        });

        // Auto-search on category change
        document.getElementById('category-filter').addEventListener('change', function () {
            if (this.value !== '') {
                performSearch();
            }
        });
    });

    async function performSearch() {
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('search-results');
        const resultsInfo = document.getElementById('results-info');

        try {
            // Show loading
            loadingIndicator.style.display = 'block';
            resultsContainer.innerHTML = '';

            // Collect search parameters
            const params = {
                query: document.getElementById('search-query').value.trim(),
                category: document.getElementById('category-filter').value,
                limit: parseInt(document.getElementById('results-limit').value),
                min_size: document.getElementById('min-size').value || undefined,
                max_size: document.getElementById('max-size').value || undefined
            };

            // Remove empty parameters
            Object.keys(params).forEach(key => {
                if (params[key] === '' || params[key] === undefined) {
                    delete params[key];
                }
            });

            // Perform search
            const response = await API.get('files', params);
            currentSearchData = response.files || [];

            // Hide loading
            loadingIndicator.style.display = 'none';

            // Update results info
            resultsInfo.textContent = `Found ${response.count} files`;

            // Render results
            renderSearchResults(currentSearchData);

        } catch (error) {
            console.error('Search failed:', error);
            loadingIndicator.style.display = 'none';
            resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Search failed: ${error.message}
            </div>
        `;
            resultsInfo.textContent = '';
        }
    }

    function renderSearchResults(files, sortConfig = {}) {
        const resultsContainer = document.getElementById('search-results');

        if (!files || files.length === 0) {
            resultsContainer.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-search fs-1"></i>
                <p class="mb-0">No files found matching your criteria</p>
            </div>
        `;
            return;
        }

        // Create table
        const tableHtml = `
        <div class="table-responsive">
            <table class="table table-hover table-sm file-table" id="search-results-table">
                <thead>
                    <tr>
                        ${TableUtils.createSortableHeader('Name', 'filename', sortConfig)}
                        ${TableUtils.createSortableHeader('Category', 'category', sortConfig)}
                        ${TableUtils.createSortableHeader('Size', 'size', sortConfig)}
                        ${TableUtils.createSortableHeader('Modified', 'modified_date', sortConfig)}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${files.map(file => `
                        <tr class="search-result-item" data-file-id="${file.id}">
                            <td>
                                <div class="fw-medium">${file.filename}</div>
                                <small class="text-muted file-path">${file.path}</small>
                            </td>
                            <td>
                                ${Utils.getCategoryBadge(file.category)}
                            </td>
                            <td class="file-size">
                                ${Utils.formatFileSize(file.size)}
                            </td>
                            <td>
                                <small>${Utils.formatDate(file.modified_date)}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="viewFileDetails('${file.id}')"
                                            title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm copy-file-btn" 
                                            data-file-path="${file.path}"
                                            title="Copy File Path">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-info btn-sm copy-folder-btn" 
                                            data-file-path="${file.path}"
                                            title="Copy Folder Path">
                                        <i class="bi bi-folder"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteFile('${file.id}')"
                                            title="Delete Record">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

        resultsContainer.innerHTML = tableHtml;

        // Add sorting functionality
        const table = document.getElementById('search-results-table');
        TableUtils.addSortingToTable(table, files, (sortedData, sortConfig) => {
            renderSearchResults(sortedData, sortConfig);
        });
        
        // Add event listeners for copy buttons
        addCopyButtonListeners();
    }

    function clearSearch() {
        document.getElementById('search-form').reset();
        document.getElementById('search-results').innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="bi bi-search fs-1"></i>
            <p class="mb-0">Enter search criteria and click "Search" to find files</p>
        </div>
    `;
        document.getElementById('results-info').textContent = '';
        currentSearchData = [];
    }

    function viewFileDetails(fileId) {
        const file = currentSearchData.find(f => f.id === fileId);
        if (!file) return;

        // Create modal content
        const modalHtml = `
        <div class="modal fade" id="fileDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">File Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <dl class="row">
                            <dt class="col-sm-3">Name:</dt>
                            <dd class="col-sm-9">${file.filename}</dd>
                            
                            <dt class="col-sm-3">Path:</dt>
                            <dd class="col-sm-9">
                                <div class="bg-light p-2 rounded text-monospace small text-break" style="word-break: break-all;">
                                    ${file.path}
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-secondary btn-sm me-2 copy-file-btn" 
                                            data-file-path="${file.path}">
                                        <i class="bi bi-clipboard me-1"></i>Copy File Path
                                    </button>
                                    <button class="btn btn-outline-info btn-sm copy-folder-btn" 
                                            data-file-path="${file.path}">
                                        <i class="bi bi-folder me-1"></i>Copy Folder Path
                                    </button>
                                </div>
                            </dd>
                            
                            <dt class="col-sm-3">Category:</dt>
                            <dd class="col-sm-9">${Utils.getCategoryBadge(file.category)}</dd>
                            
                            <dt class="col-sm-3">Size:</dt>
                            <dd class="col-sm-9">${Utils.formatFileSize(file.size)}</dd>
                            
                            <dt class="col-sm-3">Modified:</dt>
                            <dd class="col-sm-9">${Utils.formatDate(file.modified_date)}</dd>
                            
                            <dt class="col-sm-3">Scanned:</dt>
                            <dd class="col-sm-9">${Utils.formatDate(file.scanned_date)}</dd>
                            
                            <dt class="col-sm-3">Status:</dt>
                            <dd class="col-sm-9">
                                <span class="badge ${file.exists ? 'bg-success' : 'bg-danger'}">
                                    ${file.exists ? 'Exists' : 'Missing'}
                                </span>
                            </dd>
                        </dl>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Remove existing modal
        const existingModal = document.getElementById('fileDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('fileDetailsModal'));
        modal.show();

        // Clean up when modal is hidden
        document.getElementById('fileDetailsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    function copyFilePath(filePath) {
        console.log('Copying file path:', filePath); // Debug log
        
        navigator.clipboard.writeText(filePath).then(() => {
            Utils.showToast('File path copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy file path:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = filePath;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            Utils.showToast('File path copied to clipboard!', 'success');
        });
    }

    function copyFolderPath(filePath) {
        console.log('Original file path:', filePath); // Debug log
        
        // Extract folder path from file path - handle both Windows and POSIX separators
        const backslashIndex = filePath.lastIndexOf('\\');
        const forwardslashIndex = filePath.lastIndexOf('/');
        const lastSeparatorIndex = Math.max(backslashIndex, forwardslashIndex);
        
        if (lastSeparatorIndex === -1) {
            // No path separator found, return empty or current directory
            Utils.showToast('No folder path found', 'warning');
            return;
        }
        
        const folderPath = filePath.substring(0, lastSeparatorIndex);
        console.log('Extracted folder path:', folderPath); // Debug log

        navigator.clipboard.writeText(folderPath).then(() => {
            Utils.showToast('Folder path copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy folder path:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = folderPath;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            Utils.showToast('Folder path copied to clipboard!', 'success');
        });
    }

    function addCopyButtonListeners() {
        // Remove existing listeners to avoid duplicates
        document.querySelectorAll('.copy-file-btn').forEach(btn => {
            btn.removeEventListener('click', handleCopyFile);
        });
        document.querySelectorAll('.copy-folder-btn').forEach(btn => {
            btn.removeEventListener('click', handleCopyFolder);
        });
        
        // Add new listeners
        document.querySelectorAll('.copy-file-btn').forEach(btn => {
            btn.addEventListener('click', handleCopyFile);
        });
        document.querySelectorAll('.copy-folder-btn').forEach(btn => {
            btn.addEventListener('click', handleCopyFolder);
        });
    }
    
    function handleCopyFile(event) {
        const filePath = event.currentTarget.dataset.filePath;
        copyFilePath(filePath);
    }
    
    function handleCopyFolder(event) {
        const filePath = event.currentTarget.dataset.filePath;
        copyFolderPath(filePath);
    }

    async function deleteFile(fileId) {
        if (!confirm('Are you sure you want to delete this file record?')) {
            return;
        }

        try {
            await API.delete(`files/${fileId}`);
            Utils.showToast('File record deleted successfully', 'success');

            // Remove from current data and re-render
            currentSearchData = currentSearchData.filter(f => f.id !== fileId);
            renderSearchResults(currentSearchData);

            // Update results info
            document.getElementById('results-info').textContent = `Found ${currentSearchData.length} files`;

        } catch (error) {
            console.error('Failed to delete file:', error);
            Utils.showToast('Failed to delete file record', 'danger');
        }
    }
</script>
{% endblock %}